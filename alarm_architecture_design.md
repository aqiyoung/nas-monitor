# NAS-Monitor 告警功能架构设计

## 1. 告警类型

| 告警类型 | 子类型 | 描述 |
|---------|-------|------|
| **系统异常** | CPU高负载 | CPU使用率超过阈值 |
| | 内存不足 | 内存使用率超过阈值 |
| | 磁盘空间不足 | 磁盘使用率超过阈值 |
| | 系统宕机 | 无法连接到系统 |
| **网络异常** | 外部访问IP异常 | 来自异常IP的访问 |
| | 网络流量异常 | 网络流量超过阈值 |
| | 网络连接数异常 | 连接数超过阈值 |
| **Docker异常** | 容器异常退出 | 容器意外停止 |
| | 容器资源不足 | 容器CPU/内存使用超过限制 |
| | Docker服务异常 | Docker服务无法连接 |
| | 镜像拉取失败 | 镜像拉取失败 |

## 2. 触发条件

| 告警类型 | 默认阈值 | 可配置 |
|---------|---------|--------|
| CPU高负载 | >80% 持续30秒 | 是 |
| 内存不足 | >85% 持续30秒 | 是 |
| 磁盘空间不足 | >90% | 是 |
| 容器异常退出 | 任意退出 | 是 |
| 外部访问IP异常 | 来自黑名单IP | 是 |

## 3. 告警级别

| 级别 | 描述 | 颜色标识 |
|------|------|----------|
| 紧急 | 系统无法正常运行 | 红色 |
| 警告 | 系统性能下降 | 黄色 |
| 信息 | 正常事件通知 | 蓝色 |

## 4. 推送方式

- [ ] 系统内部通知
- [ ] 邮件推送
- [ ] Webhook通知
- [ ] 短信推送（需集成第三方服务）

## 5. 数据结构设计

### 5.1 告警配置表

```python
class AlarmConfig:
    id: str
    alarm_type: str  # 告警类型
    sub_type: str    # 子类型
    enabled: bool    # 是否启用
    threshold: float # 阈值
    duration: int    # 持续时间（秒）
    severity: str    # 告警级别
    push_methods: list[str]  # 推送方式
    created_at: datetime
    updated_at: datetime
```

### 5.2 告警记录表

```python
class AlarmRecord:
    id: str
    alarm_type: str
    sub_type: str
    severity: str
    message: str
    details: dict
    timestamp: datetime
    status: str  # 未处理、已处理、已忽略
    processed_at: datetime
    processed_by: str
```

### 5.3 外部访问IP表

```python
class AccessIP:
    id: str
    ip_address: str
    country: str
    region: str
    city: str
    is_blacklisted: bool
    first_seen: datetime
    last_seen: datetime
    total_requests: int
```

## 6. 系统架构

```
┌─────────────────────────────────────────────────────────────────────────┐
│                            NAS-Monitor                                  │
├─────────────────┬─────────────────┬─────────────────┬─────────────────┤
│   监控数据采集   │   告警检测引擎   │   告警存储管理   │   告警推送服务   │
└─────────────────┴─────────────────┴─────────────────┴─────────────────┘
          │                │                │                │
          └────────────────┴────────────────┴────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                            API接口层                                    │
└─────────────────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                            前端展示层                                    │
└─────────────────────────────────────────────────────────────────────────┘
```

## 7. 实现步骤

### 7.1 后端实现
1. 创建告警配置和记录的数据模型
2. 实现告警检测引擎
3. 实现告警存储管理
4. 实现告警推送服务
5. 新增告警相关API接口

### 7.2 前端实现
1. 告警列表展示页面
2. 告警配置页面
3. 告警详情页面
4. 实时告警通知

## 8. API接口设计

| 接口路径 | 方法 | 描述 |
|---------|------|------|
| `/api/alarm/configs` | GET | 获取所有告警配置 |
| `/api/alarm/configs` | POST | 创建告警配置 |
| `/api/alarm/configs/{id}` | PUT | 更新告警配置 |
| `/api/alarm/configs/{id}` | DELETE | 删除告警配置 |
| `/api/alarm/records` | GET | 获取告警记录 |
| `/api/alarm/records/{id}` | PUT | 更新告警状态 |
| `/api/alarm/access-ips` | GET | 获取访问IP列表 |
| `/api/alarm/access-ips/{id}` | PUT | 更新IP状态（黑名单/白名单） |
| `/api/alarm/statistics` | GET | 获取告警统计信息 |

## 9. 技术选型

- 数据存储：使用内存存储+定期持久化（JSON文件）
- 定时任务：使用APScheduler
- 推送服务：集成邮件、Webhook
- IP地理位置：使用ipinfo.io API

## 10. 实现计划

1. 实现基础数据模型和存储
2. 实现告警检测引擎
3. 实现API接口
4. 实现前端页面
5. 集成推送服务
6. 测试和优化