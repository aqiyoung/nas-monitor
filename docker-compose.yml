services:
  # 后端FastAPI服务
  backend:
    image: ghcr.io/aqiyoung/nas-monitor-backend:latest
    container_name: nas-monitor-backend
    ports:
      - "8017:8017"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /etc/os-release:/etc/os-release:ro
    environment:
      - HOST=0.0.0.0
      - PORT=8017
      - INFLUXDB_URL=http://influxdb:8086
      - INFLUXDB_TOKEN=${INFLUXDB_TOKEN:-nas_monitor_token}
      - INFLUXDB_ORG=nas_monitor
      - INFLUXDB_BUCKET=nas_metrics
      - PROMETHEUS_URL=http://prometheus:9090
    restart: unless-stopped
    depends_on:
      - influxdb

  # 前端Vue应用
  frontend:
    image: ghcr.io/aqiyoung/nas-monitor-frontend:latest
    container_name: nas-monitor-frontend
    ports:
      - "3003:80"
    restart: unless-stopped
    depends_on:
      - backend

  # Node Exporter（系统监控）
  node-exporter:
    image: prom/node-exporter:latest
    container_name: nas-node-exporter
    network_mode: host
    volumes:
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /:/rootfs:ro
    restart: unless-stopped

  # cAdvisor（容器监控）
  cadvisor:
    image: zcube/cadvisor:latest
    container_name: nas-cadvisor
    network_mode: host
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /sys:/sys:ro
      - /var/lib/docker/:/var/lib/docker:ro
    restart: unless-stopped

  # InfluxDB（时序数据存储）
  influxdb:
    image: influxdb:2.7
    container_name: nas-influxdb
    ports:
      - 8087:8086
    volumes:
      - ./influxdb/data:/var/lib/influxdb2
      - ./influxdb/config:/etc/influxdb2
    environment:
      - DOCKER_INFLUXDB_INIT_MODE=setup
      - DOCKER_INFLUXDB_INIT_USERNAME=nas_admin
      - DOCKER_INFLUXDB_INIT_PASSWORD=Nas@123456
      - DOCKER_INFLUXDB_INIT_ORG=nas_monitor
      - DOCKER_INFLUXDB_INIT_BUCKET=nas_metrics
      - DOCKER_INFLUXDB_INIT_ADMIN_TOKEN=nas_monitor_token
    restart: unless-stopped

  # Prometheus（监控数据采集和存储）
  prometheus:
    image: prom/prometheus:latest
    container_name: nas-prometheus
    user: "root"
    ports:
      - 9090:9090
    volumes:
      - ./prometheus/config:/etc/prometheus
      - ./prometheus/data:/prometheus
    restart: unless-stopped
    depends_on:
      - node-exporter
      - cadvisor
